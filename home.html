<!DOCTYPE html>
<html lang="en">

<head>
    <title>Zavi cho máy tính</title>
    <meta charset="utf-8">
    <meta http-equiv="cache-control" content="no-cache">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="description"
        content="Zavi là giải pháp họp trực tuyến an toàn và tiện lợi, chỉ cần tài khoản Zalo để bắt đầu sử dụng.">
    <link rel="icon" href="{{DOMAIN_RES}}/img/zavi_thumb.png">
    <!-- <link rel="stylesheet" href="{{DOMAIN_RES}}/css/style.css"> -->
    <link rel="stylesheet" href="https://zavi.me/public/css/style.css">

    <link type="image/x-icon" href="{{DOMAIN_RES}}/img/zavi_thumb.png" rel="shortcut icon">
    <meta property="og:title" content="Zavi cho máy tính" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="{{DOMAIN_RES}}/img/zavi_thumb.png" />
    <meta name="robots" content="noindex">
    <meta name="googlebot" content="noindex">
</head>

<body class="new-landing">
    <section class="menu">
        <div class="container flx">
            <a href="{{ZAVI_HOMEPAGE}}" class="menu__logo">
                <img src="{{DOMAIN_RES}}/img/logo.png" alt="logo zalo">
            </a>
        </div>
    </section>
    <div class="launching">
        <div class="launching--background">
            <div id="launching__info__id">
                <p class="launching__title">Mở ứng dụng...</p>
                </p>
                <p class="launching__please-open">Vui lòng nhấn mở ứng dụng tại cửa sổ thông báo</p>
            </div>
            <div id="download__info__id" style="display: none;">
                <p class="launching__title">Đang tải xuống...</p>
                </p>
                <p class="launching__please-open">Vui lòng nhấn <span class="launching__please-open__action"> Đồng ý
                        (Keep) </span> tại cửa sổ tải xuống và <span class="launching__please-open__action"> Cài đặt
                    </span>Zavi</p>
            </div>
            </p>
            <p class="launching__open-windown">Nếu cửa sổ thông báo không hiển thị ở trình duyệt,

                <a id="zidopen" href="#" class="launching__open-windown__link" onclick="launchDesktopApp()"> nhấp vào
                    đây </a>
                để mở ứng dụng hoặc
                <a {{#ZAVI_DOWNLOAD}} href="{{ZAVI_DOWNLOAD}}" {{/ZAVI_DOWNLOAD}} class="launching__open-windown__link"
                    id="launching_download_url"> tải và khởi chạy Zavi </a>
                {{#ZAVI_WEB}}
            <p> Nếu không thể tải hoặc khởi chạy ứng dụng, mở bằng <a href="{{ZAVI_WEB.LINKOPEN}}"
                    class="launching__open-windown__link">trình duyệt </a> </p> {{/ZAVI_WEB}}
            </p>
            </p>

            <p class="launching__download">Bạn có thể tải và cài đặt Zavi trực tiếp tại <a href="/"
                    class="launching__open-windown__link"> https://zavi.me </a>
            </p>
            </p>
        </div>
    </div>
    <section class="footer footer--margin">
        <div class="footer__last">
            <p>© 2020 Một sản phẩm của Zalo Group</p>
        </div>
    </section>

    <script>
        const browser = {
            'opera': {
                'name': 'opera',
                'alertW': 0,
                'alertH': 0
            },
            'firefox': {
                'name': 'firefox',
                'alertW': 410,
                'alertH': 165,
                'alertW2': 410,
                'alertH2': 275
            },
            'safari': {
                'name': 'safari',
                'alertW': 0,
                'alertH': 0
            },
            'IE': {
                'name': 'IE',
                'alertW': 0,
                'alertH': 0
            },
            'samsung': {
                'name': 'samsung',
                'alertW': 0,
                'alertH': 0
            },
            'edge': {
                'name': 'edge',
                'alertW': 0,
                'alertH': 0
            },
            'edgeChromium': {
                'name': 'edgeChromium',
                'alertW': 450,
                'alertH': 165
            },
            'chrome': {
                'name': 'chrome',
                'alertW': 517,
                'alertH': 191
            },
            'unknown': {
                'name': 'unknown',
                'alertW': 0,
                'alertH': 0
            }
        }

        const openUriResult = {
            // User clicl accept when request open app
            'success': 'success',
            // User click cancel when request open app
            'cancel': 'cancel',
            // Not exists protocol or can't detect
            'unsupport': 'unsupport'
        }

        function delectBrowser() {

            // Cache to avoid run more than one time
            if (delectBrowser.prototype._cachedBrowser)
                return delectBrowser.prototype._cachedBrowser;

            const sUsrAg = navigator.userAgent;
            let result;

            // Inspiration from https://developer.mozilla.org/en-US/docs/Web/API/Window/navigator
            if (sUsrAg.indexOf("Firefox") > -1) {
                result = browser.firefox;
                // "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0"
            } else if (sUsrAg.indexOf("SamsungBrowser") > -1) {
                result = browser.samsung;
                // "Mozilla/5.0 (Linux; Android 9; SAMSUNG SM-G955F Build/PPR1.180610.011) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/9.4 Chrome/67.0.3396.87 Mobile Safari/537.36
            } else if (sUsrAg.indexOf("Opera") > -1 || sUsrAg.indexOf("OPR") > -1) {
                result = browser.opera;
                // "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.102 Safari/537.36 OPR/57.0.3098.106"
            } else if (sUsrAg.indexOf("Trident") > -1) {
                result = browser.IE;
                // "Mozilla/5.0 (Windows NT 10.0; WOW64; Trident/7.0; .NET4.0C; .NET4.0E; Zoom 3.6.0; wbx 1.0.0; rv:11.0) like Gecko"
            } else if (sUsrAg.indexOf("Edge") > -1) {
                result = browser.edge;
                // "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36 Edge/16.16299"
            } else if (sUsrAg.indexOf("Edg") > -1 && sUsrAg.indexOf("Chrome") > -1) {
                result = browser.edgeChromium;
                // "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/66.0.3359.181 Chrome/66.0.3359.181 Safari/537.36"
            } else if (sUsrAg.indexOf("Chrome") > -1) {
                result = browser.chrome; //"Google Chrome or Chromium";
                // "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/66.0.3359.181 Chrome/66.0.3359.181 Safari/537.36"
            } else if (sUsrAg.indexOf("Safari") > -1) {
                result = browser.safari;
                // "Mozilla/5.0 (iPhone; CPU iPhone OS 11_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/11.0 Mobile/15E148 Safari/604.1 980x1306"
            } else {
                result = browser.unknown;
            }

            return delectBrowser.prototype._cachedBrowser = result;
        }

        function launchInIEnME(uri, onResult) {
            if (navigator.msLaunchUri) {
                // This proprietary method is specific to Internet Explorer,
                // and Microsoft Edge versions 18 and lower.
                // https://developer.mozilla.org/en-US/docs/Web/API/Navigator/msLaunchUri
                navigator.msLaunchUri(uri,
                    () => {
                        onResult(openUriResult.success);
                    },
                    () => {
                        onResult(openUriResult.unsupport);
                    });
            }
        }

        /**
         * Detect uri base on focus state and mouse event
         * @param {string} uri - uri need handle
         * @param {fn)} onResult - callback fn
         * @param {string} browserType - name of browser: ex firefox, chrome
         * @param {number} timeout - time to wait to 'ready' before check
         */
        function launchWithFocusAndMouseEvent(uri, onResult, browserType, timeout) {
            // Create iframe if needed
            var iframe = document.querySelector("#hiddenIframe");
            if (!iframe) {
                iframe = document.createElement("iframe");
                iframe.id = "hiddenIframe";
                iframe.style.display = "none";
                document.body.appendChild(iframe);
            }

            // Wait to check blur of not
            const blueTimeout = setTimeout(() => {
                onResult(openUriResult.unsupport);
                window.removeEventListener('focus', onFocus);
                window.removeEventListener('blur', onBlur);
            }, timeout);

            var mouses = {};

            const inDangerArea = (mouses) => {

                if (!mouses.x) {
                    return true;
                }

                var sw = window.innerWidth ||
                    document.documentElement.clientWidth ||
                    document.body.clientWidth;

                const alertW = browserType.alertW,
                    alertH = browserType.alertH;
                const del = 40;

                const matchX = (mouses.x < 0.5 * (sw + alertW) + del) && (mouses.x > 0.5 * (sw + alertW) - 100);
                const matchY = (mouses.y < alertH + del) && (mouses.y > alertH - 65);

                const result = matchX && matchY;
                if (browserType.name === browser.firefox.name && !result) {
                    const alertW = browserType.alertW2,
                        alertH = browserType.alertH2;
                    const matchX2 = (mouses.x < 0.5 * (sw + alertW) + del) && (mouses.x > 0.5 * (sw + alertW) - 100);
                    const matchY2 = (mouses.y < alertH + del) && (mouses.y > alertH - 65);

                    return matchX2 && matchY2;
                }

                return result;
            }

            function onMouseMove(e) {
                if (!mouses.x) {
                    mouses = {
                        x: e.clientX,
                        y: e.clientY
                    };
                }
            }

            function onBlur() {
                // If come here, we believe uri is correct
                clearTimeout(blueTimeout);
                window.addEventListener('mousemove', onMouseMove);
            }

            function onFocus() {

                setTimeout(() => {
                    if (document.hasFocus()) {
                        // Cancel or back from app
                        onResult(inDangerArea(mouses) ? openUriResult.cancel : openUriResult.success);
                    } else {
                        // Accept open app cause blur again
                        onResult(openUriResult.success);
                    }

                    window.removeEventListener('mousemove', onMouseMove);
                }, 500);

                window.removeEventListener('blur', onBlur);
                window.removeEventListener('focus', onFocus);
            }

            window.addEventListener('blur', onBlur);
            window.addEventListener('focus', onFocus);

            // iframe.contentWindow.top.location.href = uri;
            iframe.contentWindow.location.href = uri;
        }

        /**
         * 
         * @param {string} uri - uri need handle
         * @param {fn} onResult - callback fn
         * @param {object} options - optional info to process
         */
        function openCustomProtocol(uri, onResult, options = {}) {
            const timeout = options.timeout ? options.timeout : 1000;
            const browserName = options.browserName ? options.browserName : "Unknown";

            // make sure passed value is valid
            const myBrowser = browser[browserName] ? browserName : delectBrowser();

            switch (myBrowser.name) {
                case browser.edge.name:
                case browser.IE.name:
                    launchInIEnME(uri, onResult);
                    break;

                case browser.firefox.name:
                case browser.edgeChromium.name:
                case browser.safari.name:
                case browser.chrome.name:
                case browser.opera.name:
                    launchWithFocusAndMouseEvent(uri, onResult, myBrowser, timeout)
                    break;

                default:
                    onResult(openUriResult.unsupport);
            }
        }

    </script>

    <script type="text/javascript">
        function launchDesktopApp() {
            if (navigator.userAgent.toLocaleLowerCase().indexOf("android") >= 0 ||
                navigator.userAgent.toLocaleLowerCase().indexOf("iphone") >= 0 ||
                navigator.userAgent.toLocaleLowerCase().indexOf("ipad simulator") >= 0 ||
                navigator.userAgent.toLocaleLowerCase().indexOf("ipad") >= 0 ||
                navigator.userAgent.toLocaleLowerCase().indexOf("iphone simulator") >= 0) {

                function launchIfCan() {
                    let url = "{{ZAVI_PROTOCOL}}"
                    console.log(url);
                    document.location.href = url;
                    try {
                        document.querySelector("#zidopen").setAttribute("href", url);
                    } catch (e) { }
                }
                setTimeout(function () {
                    launchIfCan();
                }, 100);
            } else {

                function changeLayoutToDownload() {
                    try {
                        let e = document.getElementById("launching__info__id"),
                            t = document.getElementById("download__info__id");
                        e && t && (e.style.display = "none", t.style.display = "block")
                    } catch (e) { }
                }

                setTimeout(function () {
                    function e(e) {
                        var t = "";
                        try {
                            t = new URL(window.location.href).searchParams.get(e) || ""
                        } catch (n) {
                            t = function (e) {
                                try {
                                    e = e.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
                                    var t = new RegExp("[\\?&]" + e + "=([^&#]*)").exec(location.search);
                                    return null === t ? "" : decodeURIComponent(t[1].replace(/\+/g, " "))
                                } catch (e) { } return ""
                            }(e)
                        } return /^[A-Za-z0-9+\/]+\={0,2}$/.test(t) || (t = ""), t
                    }

                    !function () {
                        if (!function () {
                            try {
                                if (navigator && navigator.platform) {
                                    let e = ["win32", "ipad simulator", "iphone simulator", "ipad", "iphone", "macintel"],
                                        t = navigator.platform.toLowerCase(); if (-1 !== e.indexOf(t)) return !0
                                }
                            } catch (e) {
                                console.error("[validDevice] ERR ", e)
                            }
                            return !1
                        }())
                            return void console.info("[launch] not valid device");

                        let t = e("id"), n = e("token");
                        const HOST_PROTOCAL_LAUCHING = "zavi.me"; // TODO: change this value
                        const tParam = (new URLSearchParams(window.location.search)).get('t');
                        const protocol = (tParam === 'co') ? 'zavi-corp' : 'zavi';
                        const uri = `${protocol}://${HOST_PROTOCAL_LAUCHING}/join?id=` + encodeURIComponent(t) + "&token=" + encodeURIComponent(n);

                        openCustomProtocol(uri, r => {
                            if (r === openUriResult.unsupport) {
                                console.log('need download'); // TODO: Remove this line
                                window.location.href = "https://res-update-pc.zadn.vn/zavi/beta/win/ZaviSetup-21.6.1-Beta.10.exe"; // TODO: replace download link
                                changeLayoutToDownload();
                            }
                        })
                    }()
                }, 200);
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            console.log('DOM fully loaded and parsed');
            launchDesktopApp();
        });
    </script>

</body>

</html>